# ECG Video Pipeline - 인프라 상세 구성 문서

## 📋 목차

- [VPC 및 네트워크 구성](#vpc-및-네트워크-구성)
- [보안 그룹 설정](#보안-그룹-설정)
- [ECS Fargate 구성](#ecs-fargate-구성)
- [EC2 인스턴스 설정](#ec2-인스턴스-설정)
- [S3 스토리지 구성](#s3-스토리지-구성)
- [CloudFront CDN 설정](#cloudfront-cdn-설정)
- [IAM 권한 구성](#iam-권한-구성)
- [Load Balancer 설정](#load-balancer-설정)

---

## VPC 및 네트워크 구성

### VPC (Virtual Private Cloud)

| 설정 항목          | 값            | 설명                           |
| ------------------ | ------------- | ------------------------------ |
| **IPv4 CIDR 블록** | `10.0.0.0/16` | 65,536개 IP 주소 할당 가능     |
| **IPv6 CIDR 블록** | `없음`        | IPv6 미사용 (비용 절약)        |
| **DNS 호스트명**   | `활성화`      | 인스턴스에 DNS 이름 할당       |
| **DNS 해상도**     | `활성화`      | DNS 쿼리 지원                  |
| **테넌시**         | `기본값`      | 공유 하드웨어 사용 (비용 효율) |

**선택 이유**: 10.0.0.0/16은 RFC 1918 사설 IP 대역으로, 충분한 IP 주소 공간 제공

### 서브넷 구성

#### 퍼블릭 서브넷

| 서브넷              | IPv4 CIDR     | 가용영역   | 용도             | IP 개수 |
| ------------------- | ------------- | ---------- | ---------------- | ------- |
| **Public Subnet 1** | `10.0.1.0/24` | us-east-1a | ALB, NAT Gateway | 256개   |
| **Public Subnet 2** | `10.0.2.0/24` | us-east-1b | ALB, NAT Gateway | 256개   |

**설정값**:

- **퍼블릭 IP 자동 할당**: `활성화` - 인터넷 게이트웨이 연결
- **가용영역**: 서로 다른 AZ에 배치 (고가용성)

#### 프라이빗 서브넷

| 서브넷               | IPv4 CIDR      | 가용영역   | 용도     | IP 개수 |
| -------------------- | -------------- | ---------- | -------- | ------- |
| **Private Subnet 1** | `10.0.10.0/24` | us-east-1a | ECS, EC2 | 256개   |
| **Private Subnet 2** | `10.0.20.0/24` | us-east-1b | ECS, EC2 | 256개   |

**설정값**:

- **퍼블릭 IP 자동 할당**: `비활성화` - 보안을 위한 내부 네트워크
- **NAT 게이트웨이**: 각 서브넷별 전용 NAT GW (아웃바운드 인터넷 접근)

### 라우팅 테이블

#### 퍼블릭 라우팅 테이블

| 목적지        | 대상              | 설명             |
| ------------- | ----------------- | ---------------- |
| `10.0.0.0/16` | 로컬              | VPC 내부 통신    |
| `0.0.0.0/0`   | 인터넷 게이트웨이 | 모든 외부 트래픽 |

#### 프라이빗 라우팅 테이블 (각 서브넷별)

| 목적지        | 대상           | 설명              |
| ------------- | -------------- | ----------------- |
| `10.0.0.0/16` | 로컬           | VPC 내부 통신     |
| `0.0.0.0/0`   | NAT 게이트웨이 | 아웃바운드만 허용 |

### NAT 게이트웨이

| 설정             | 값          | 설명                         |
| ---------------- | ----------- | ---------------------------- |
| **개수**         | `2개`       | 각 가용영역별 1개 (고가용성) |
| **연결성 유형**  | `퍼블릭`    | 인터넷 연결                  |
| **Elastic IP**   | `자동 할당` | 고정 퍼블릭 IP               |
| **월 예상 비용** | `$64`       | $32/개 × 2개                 |

---

## 보안 그룹 설정

### ALB 보안 그룹 (`alb-sg`)

#### 인바운드 규칙

| 포트  | 프로토콜 | 소스        | 설명            |
| ----- | -------- | ----------- | --------------- |
| `80`  | TCP      | `0.0.0.0/0` | HTTP 웹 트래픽  |
| `443` | TCP      | `0.0.0.0/0` | HTTPS 웹 트래픽 |

#### 아웃바운드 규칙

| 포트        | 프로토콜      | 대상        | 설명                 |
| ----------- | ------------- | ----------- | -------------------- |
| `모든 포트` | 모든 프로토콜 | `0.0.0.0/0` | 모든 아웃바운드 허용 |

### ECS 보안 그룹 (`ecs-sg`)

#### 인바운드 규칙

| 포트   | 프로토콜 | 소스                | 설명              |
| ------ | -------- | ------------------- | ----------------- |
| `8000` | TCP      | ALB 보안 그룹       | FastAPI 서버 포트 |
| `8000` | TCP      | 모델 서버 보안 그룹 | EC2에서 직접 접근 |

#### 아웃바운드 규칙

| 포트        | 프로토콜      | 대상        | 설명            |
| ----------- | ------------- | ----------- | --------------- |
| `모든 포트` | 모든 프로토콜 | `0.0.0.0/0` | S3, ECR 접근 등 |

### 모델 서버 보안 그룹 (`model-server-sg`)

#### 인바운드 규칙

| 포트   | 프로토콜 | 소스          | 설명                           |
| ------ | -------- | ------------- | ------------------------------ |
| `8080` | TCP      | ECS 보안 그룹 | ML 모델 API 서버               |
| `22`   | TCP      | `0.0.0.0/0`   | SSH 접속 (운영시 IP 제한 필요) |

#### 아웃바운드 규칙

| 포트        | 프로토콜      | 대상        | 설명                     |
| ----------- | ------------- | ----------- | ------------------------ |
| `모든 포트` | 모든 프로토콜 | `0.0.0.0/0` | S3 접근, 패키지 다운로드 |

---

## ECS Fargate 구성

### ECR 저장소

| 설정 항목              | 값                             | 설명                    |
| ---------------------- | ------------------------------ | ----------------------- |
| **저장소 이름**        | `ecg-project-pipeline-dev-api` | 컨테이너 이미지 저장소  |
| **이미지 태그 변경성** | `MUTABLE`                      | 같은 태그 덮어쓰기 허용 |
| **이미지 스캔**        | `푸시 시 스캔`                 | 보안 취약점 자동 검사   |
| **수명주기 정책**      | `없음`                         | 모든 이미지 보관        |

### ECS 클러스터

| 설정 항목          | 값                                 | 설명                  |
| ------------------ | ---------------------------------- | --------------------- |
| **클러스터 이름**  | `ecg-project-pipeline-dev-cluster` | Fargate 클러스터      |
| **용량 공급자**    | `FARGATE`                          | 서버리스 컨테이너     |
| **실행 명령 로깅** | `CloudWatch`                       | 디버깅용 로그         |
| **네트워크 모드**  | `awsvpc`                           | VPC 네이티브 네트워킹 |

### 태스크 정의

| 설정 항목         | 값                     | 설명                 |
| ----------------- | ---------------------- | -------------------- |
| **CPU**           | `512 유닛`             | 0.5 vCPU             |
| **메모리**        | `1024 MB`              | 1GB RAM              |
| **네트워크 모드** | `awsvpc`               | ENI 할당             |
| **운영 체제**     | `Linux`                | x86_64 아키텍처      |
| **실행 역할**     | `ecsTaskExecutionRole` | ECR, CloudWatch 접근 |
| **태스크 역할**   | `ecsTaskRole`          | S3 접근 권한         |

### 컨테이너 정의

| 설정 항목         | 값            | 설명                 |
| ----------------- | ------------- | -------------------- |
| **컨테이너 이름** | `api`         | FastAPI 애플리케이션 |
| **포트 매핑**     | `8000`        | HTTP 서버 포트       |
| **CPU 예약**      | `0`           | 공유 CPU             |
| **메모리 예약**   | `소프트 제한` | 메모리 공유 허용     |
| **필수 컨테이너** | `true`        | 실패 시 태스크 중단  |

### 환경 변수

| 변수명               | 값                     | 설명               |
| -------------------- | ---------------------- | ------------------ |
| `AWS_DEFAULT_REGION` | `us-east-1`            | AWS 리전           |
| `S3_BUCKET_NAME`     | `동적 할당`            | 비디오 저장 버킷   |
| `MODEL_SERVER_URL`   | `http://{EC2_IP}:8080` | ML 서버 엔드포인트 |

### 헬스체크

| 설정 항목          | 값                                     | 설명                   |
| ------------------ | -------------------------------------- | ---------------------- |
| **명령어**         | `curl -f http://localhost:8000/health` | HTTP 헬스체크          |
| **간격**           | `30초`                                 | 체크 주기              |
| **타임아웃**       | `5초`                                  | 응답 대기 시간         |
| **재시도 횟수**    | `3회`                                  | 연속 실패 시 unhealthy |
| **시작 대기 시간** | `0초`                                  | 즉시 체크 시작         |

### ECS 서비스

| 설정 항목          | 값                | 설명                         |
| ------------------ | ----------------- | ---------------------------- |
| **시작 유형**      | `FARGATE`         | 서버리스 컨테이너            |
| **원하는 수**      | `2`               | 고가용성을 위한 2개 인스턴스 |
| **최대 비율**      | `200%`            | 롤링 업데이트 시 최대 4개    |
| **최소 정상 비율** | `50%`             | 업데이트 시 최소 1개 유지    |
| **플랫폼 버전**    | `LATEST`          | 최신 Fargate 플랫폼          |
| **서브넷**         | `프라이빗 서브넷` | 보안을 위한 내부 배치        |
| **퍼블릭 IP**      | `비활성화`        | ALB를 통해서만 접근          |

### 로드 밸런서 연결

| 설정 항목         | 값     | 설명              |
| ----------------- | ------ | ----------------- |
| **대상 그룹**     | `api`  | ALB 타겟 그룹     |
| **컨테이너 포트** | `8000` | FastAPI 서버 포트 |
| **프로토콜**      | `HTTP` | ALB와 통신        |

---

## EC2 인스턴스 설정

### 인스턴스 구성

| 설정 항목         | 값                              | 설명                            |
| ----------------- | ------------------------------- | ------------------------------- |
| **인스턴스 타입** | `g4dn.xlarge`                   | NVIDIA T4 GPU, 4 vCPU, 16GB RAM |
| **AMI**           | `Deep Learning AMI GPU PyTorch` | GPU 최적화 이미지               |
| **가용영역**      | `us-east-1a`                    | 프라이빗 서브넷 1               |
| **퍼블릭 IP**     | `없음`                          | 보안을 위한 내부 접근만         |
| **모니터링**      | `기본 모니터링`                 | 5분 간격 CloudWatch             |
| **키 페어**       | `model-server-key`              | SSH 접속용 키                   |

### EBS 볼륨

| 설정 항목        | 값         | 설명                        |
| ---------------- | ---------- | --------------------------- |
| **볼륨 타입**    | `gp3`      | 범용 SSD (3세대)            |
| **볼륨 크기**    | `50 GB`    | ML 모델 및 데이터 저장      |
| **IOPS**         | `3000`     | 기본 성능                   |
| **처리량**       | `125 MB/s` | 기본 처리량                 |
| **암호화**       | `비활성화` | KMS 키 이슈로 인해 비활성화 |
| **삭제 시 종료** | `true`     | 인스턴스 삭제 시 함께 삭제  |

### IAM 인스턴스 프로파일

| 설정 항목     | 값                  | 설명                  |
| ------------- | ------------------- | --------------------- |
| **역할 이름** | `model-server-role` | EC2 서비스 역할       |
| **정책**      | `S3 접근 권한`      | 비디오 파일 읽기/쓰기 |

### User Data 스크립트

```bash
#!/bin/bash
# 시스템 업데이트 및 Docker 설치
yum update -y
amazon-linux-extras install docker -y
systemctl start docker
systemctl enable docker

# Python ML 라이브러리 설치
pip3 install torch torchvision torchaudio fastapi uvicorn boto3

# ML 모델 서버 자동 생성 및 systemd 서비스 등록
# 8080 포트에서 FastAPI 서버 실행
```

### 보안 그룹

**연결된 보안 그룹**: `model-server-sg`

- 8080 포트: ECS에서 ML API 호출
- 22 포트: SSH 관리 접속

---

## S3 스토리지 구성

### 프론트엔드 정적 파일 버킷 ⭐ **신규**

| 설정 항목         | 값                                           | 설명                      |
| ----------------- | -------------------------------------------- | ------------------------- |
| **버킷 이름**     | `ecg-project-pipeline-dev-frontend-{random}` | Next.js 정적 파일 전용    |
| **리전**          | `us-east-1`                                  | 버지니아 북부 리전        |
| **용도**          | `Next.js Static Export`                      | HTML, CSS, JS 파일        |
| **퍼블릭 액세스** | `모두 차단`                                  | CloudFront OAC로만 접근   |
| **월 예상 비용**  | `~$1-3`                                      | 저장 비용 (사용량에 따라) |

### 비디오 저장 버킷

| 설정 항목         | 값                                                | 설명                  |
| ----------------- | ------------------------------------------------- | --------------------- |
| **버킷 이름**     | `ecg-project-pipeline-dev-video-storage-{random}` | 글로벌 고유 이름      |
| **리전**          | `us-east-1`                                       | 버지니아 북부 리전    |
| **버전 관리**     | `활성화`                                          | 파일 이력 보관        |
| **퍼블릭 액세스** | `모두 차단`                                       | 보안을 위한 완전 차단 |

### 암호화 설정

| 설정 항목              | 값          | 설명                  |
| ---------------------- | ----------- | --------------------- |
| **서버 사이드 암호화** | `AES-256`   | AWS 관리형 키         |
| **버킷 키**            | `비활성화`  | 기본 설정             |
| **기본 암호화**        | `모든 객체` | 업로드 시 자동 암호화 |

### CORS 설정

```json
{
  "AllowedHeaders": ["*"],
  "AllowedMethods": ["GET", "POST", "PUT", "DELETE"],
  "AllowedOrigins": ["*"],
  "ExposeHeaders": ["ETag"],
  "MaxAgeSeconds": 3000
}
```

### CloudFront 로그 버킷

| 설정 항목         | 값                                                  | 설명           |
| ----------------- | --------------------------------------------------- | -------------- |
| **버킷 이름**     | `ecg-project-pipeline-dev-cloudfront-logs-{random}` | 로그 전용 버킷 |
| **퍼블릭 액세스** | `모두 차단`                                         | 로그 보안      |
| **수명주기 정책** | `없음`                                              | 수동 관리      |

---

## CloudFront CDN 설정

### 배포 구성

| 설정 항목          | 값               | 설명                 |
| ------------------ | ---------------- | -------------------- |
| **배포 상태**      | `활성화`         | CDN 서비스 활성      |
| **가격 클래스**    | `PriceClass_100` | 미국, 캐나다, 유럽만 |
| **HTTP 버전**      | `HTTP/2`         | 성능 최적화          |
| **IPv6**           | `활성화`         | IPv6 클라이언트 지원 |
| **기본 루트 객체** | `index.html`     | SPA 애플리케이션     |

### Origin 설정 ⭐ **업데이트됨**

#### S3 Origin (프론트엔드 정적 파일) - **주 Origin**

| 설정 항목                 | 값                                           | 설명                 |
| ------------------------- | -------------------------------------------- | -------------------- |
| **도메인 이름**           | `frontend-bucket.s3.us-east-1.amazonaws.com` | 프론트엔드 전용 버킷 |
| **Origin ID**             | `S3-frontend-bucket`                         | 고유 식별자          |
| **Origin Access Control** | `활성화`                                     | 보안 접근 제어       |
| **용도**                  | `Next.js 정적 파일 서빙`                     | HTML, CSS, JS        |

#### S3 Origin (비디오 파일)

| 설정 항목                 | 값                                        | 설명             |
| ------------------------- | ----------------------------------------- | ---------------- |
| **도메인 이름**           | `video-bucket.s3.us-east-1.amazonaws.com` | 비디오 전용 버킷 |
| **Origin ID**             | `S3-video-bucket`                         | 고유 식별자      |
| **Origin Access Control** | `활성화`                                  | 보안 접근 제어   |
| **용도**                  | `비디오 파일 스트리밍`                    | MP4, MOV 등      |

#### ALB Origin (API 서버)

| 설정 항목         | 값                      | 설명                      |
| ----------------- | ----------------------- | ------------------------- |
| **도메인 이름**   | `{alb-dns-name}`        | Application Load Balancer |
| **Origin ID**     | `ALB-{alb-name}`        | 고유 식별자               |
| **프로토콜 정책** | `HTTP Only`             | ALB는 HTTP 사용           |
| **포트**          | `80`                    | HTTP 표준 포트            |
| **용도**          | `FastAPI 백엔드 서비스` | REST API                  |

### 캐시 동작

#### 기본 캐시 동작 (프론트엔드) ⭐ **업데이트됨**

| 설정 항목              | 값                         | 설명                    |
| ---------------------- | -------------------------- | ----------------------- |
| **경로 패턴**          | `기본값 (*)`               | 모든 요청 (최우선 순위) |
| **Origin**             | `S3 Frontend Origin`       | Next.js 정적 파일 서빙  |
| **뷰어 프로토콜 정책** | `Redirect HTTP to HTTPS`   | 보안 강제               |
| **허용된 HTTP 메서드** | `GET, HEAD, OPTIONS`       | 정적 파일 읽기          |
| **캐시 정책**          | `Managed-CachingOptimized` | 장기간 캐싱             |
| **압축**               | `활성화`                   | JS, CSS 파일 압축       |

#### API 캐시 동작

| 설정 항목              | 값                | 설명                   |
| ---------------------- | ----------------- | ---------------------- |
| **경로 패턴**          | `/api/*`          | API 요청만             |
| **Origin**             | `ALB Origin`      | FastAPI 서버로 전달    |
| **뷰어 프로토콜 정책** | `HTTPS Only`      | 보안 연결만            |
| **허용된 HTTP 메서드** | `모든 메서드`     | POST, PUT, DELETE 지원 |
| **캐시 정책**          | `CachingDisabled` | API 응답 캐싱 안함     |
| **Origin 요청 정책**   | `AllViewer`       | 모든 헤더, 쿠키 전달   |

#### 비디오 캐시 동작

| 설정 항목              | 값                                       | 설명                    |
| ---------------------- | ---------------------------------------- | ----------------------- |
| **경로 패턴**          | `/videos/*`                              | 비디오 파일만           |
| **Origin**             | `S3 Video Origin`                        | 비디오 파일 스트리밍    |
| **뷰어 프로토콜 정책** | `Redirect HTTP to HTTPS`                 | 보안 강제               |
| **허용된 HTTP 메서드** | `GET, HEAD`                              | 읽기 전용               |
| **캐시 정책**          | `CachingOptimizedForUncompressedObjects` | 비디오 최적화           |
| **압축**               | `비활성화`                               | 비디오 파일은 압축 안함 |

### 로깅

| 설정 항목       | 값                 | 설명           |
| --------------- | ------------------ | -------------- |
| **액세스 로깅** | `활성화`           | 요청 로그 기록 |
| **로그 버킷**   | `cloudfront-logs`  | 전용 S3 버킷   |
| **로그 접두사** | `cloudfront-logs/` | 파일 경로 구분 |
| **쿠키 포함**   | `비활성화`         | 민감정보 제외  |

---

## IAM 권한 구성

### ECS 태스크 실행 역할

| 설정 항목       | 값                                 | 설명                 |
| --------------- | ---------------------------------- | -------------------- |
| **역할 이름**   | `ecs-task-execution-role`          | Fargate 실행 권한    |
| **신뢰 엔터티** | `ecs-tasks.amazonaws.com`          | ECS 서비스           |
| **관리 정책**   | `AmazonECSTaskExecutionRolePolicy` | ECR, CloudWatch 접근 |

#### 포함된 권한

- ECR에서 이미지 pull
- CloudWatch Logs에 로그 전송
- Secrets Manager에서 환경변수 조회

### ECS 태스크 역할

| 설정 항목            | 값                        | 설명                   |
| -------------------- | ------------------------- | ---------------------- |
| **역할 이름**        | `ecs-task-role`           | 애플리케이션 실행 권한 |
| **신뢰 엔터티**      | `ecs-tasks.amazonaws.com` | ECS 태스크             |
| **사용자 정의 정책** | `S3 접근 정책`            | 비디오 파일 관리       |

#### S3 접근 권한

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": [
        "s3:GetObject",
        "s3:PutObject",
        "s3:DeleteObject",
        "s3:ListBucket"
      ],
      "Resource": ["arn:aws:s3:::video-bucket", "arn:aws:s3:::video-bucket/*"]
    }
  ]
}
```

### 모델 서버 역할 (EC2)

| 설정 항목            | 값                  | 설명                       |
| -------------------- | ------------------- | -------------------------- |
| **역할 이름**        | `model-server-role` | EC2 인스턴스 역할          |
| **신뢰 엔터티**      | `ec2.amazonaws.com` | EC2 서비스                 |
| **사용자 정의 정책** | `S3 접근 정책`      | 비디오 처리를 위한 S3 접근 |

#### S3 접근 권한 (EC2용)

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": ["s3:GetObject", "s3:PutObject", "s3:ListBucket"],
      "Resource": ["arn:aws:s3:::video-bucket", "arn:aws:s3:::video-bucket/*"]
    }
  ]
}
```

### CloudFront Origin Access Control

| 설정 항목         | 값       | 설명             |
| ----------------- | -------- | ---------------- |
| **OAC 이름**      | `s3-oac` | S3 접근 제어     |
| **Origin 타입**   | `S3`     | S3 버킷용        |
| **서명 동작**     | `항상`   | 모든 요청 서명   |
| **서명 프로토콜** | `sigv4`  | AWS Signature V4 |

---

## Load Balancer 설정

### Application Load Balancer

| 설정 항목        | 값                             | 설명            |
| ---------------- | ------------------------------ | --------------- |
| **이름**         | `ecg-project-pipeline-dev-alb` | ALB 식별자      |
| **체계**         | `internet-facing`              | 인터넷 연결     |
| **IP 주소 유형** | `IPv4`                         | IPv4 전용       |
| **VPC**          | `main`                         | 메인 VPC        |
| **서브넷**       | `퍼블릭 서브넷 2개`            | 고가용성        |
| **보안 그룹**    | `alb-sg`                       | HTTP/HTTPS 허용 |
| **삭제 보호**    | `비활성화`                     | 개발 환경용     |

### 리스너

| 설정 항목     | 값        | 설명               |
| ------------- | --------- | ------------------ |
| **프로토콜**  | `HTTP`    | 포트 80            |
| **기본 작업** | `Forward` | 타겟 그룹으로 전달 |
| **타겟 그룹** | `api`     | ECS 서비스         |

### 타겟 그룹

| 설정 항목     | 값                                | 설명             |
| ------------- | --------------------------------- | ---------------- |
| **이름**      | `ecg-project-pipeline-dev-api-tg` | 타겟 그룹 식별자 |
| **타겟 타입** | `IP`                              | Fargate IP 주소  |
| **프로토콜**  | `HTTP`                            | 포트 8000        |
| **VPC**       | `main`                            | 메인 VPC         |
| **HTTP 버전** | `HTTP1`                           | 기본 버전        |

### 헬스체크

| 설정 항목         | 값        | 설명                        |
| ----------------- | --------- | --------------------------- |
| **프로토콜**      | `HTTP`    | 헬스체크 프로토콜           |
| **포트**          | `8000`    | 컨테이너 포트               |
| **경로**          | `/health` | FastAPI 헬스체크 엔드포인트 |
| **간격**          | `30초`    | 체크 주기                   |
| **타임아웃**      | `5초`     | 응답 대기 시간              |
| **정상 임계값**   | `5회`     | 연속 성공 시 healthy        |
| **비정상 임계값** | `2회`     | 연속 실패 시 unhealthy      |
| **성공 코드**     | `200`     | HTTP 응답 코드              |

---

## 📊 예상 비용 분석

### 월별 예상 비용 ⭐ **S3 정적 호스팅 반영**

| 서비스                        | 사양                           | 월 예상 비용 (USD) |
| ----------------------------- | ------------------------------ | ------------------ |
| **EC2 g4dn.xlarge**           | GPU 인스턴스 24/7              | $380.16            |
| **ECS Fargate**               | 0.5 vCPU, 1GB × 2개 (백엔드만) | $21.90             |
| **Application Load Balancer** | 표준 ALB                       | $20.44             |
| **NAT Gateway**               | 2개 AZ                         | $64.26             |
| **CloudFront**                | PriceClass_100 + 3 Origins     | $1.00 + 전송량     |
| **S3 스탠다드**               | 프론트엔드 + 비디오 저장       | $1-5 + 사용량      |
| **CloudWatch Logs**           | 7일 보관                       | $1.00              |
| **Elastic IP**                | NAT용 2개                      | $7.30              |
| **총 고정 비용**              |                                | **~$496-500/월**   |

### 💰 S3 정적 호스팅 비용 절약 ⭐ **신규 정보**

| 방식                      | 월 비용 | 절약액     | 장점                 |
| ------------------------- | ------- | ---------- | -------------------- |
| **이전 (ECS 프론트엔드)** | ~$517   | -          | SSR, API Routes 지원 |
| **현재 (S3 정적)**        | ~$498   | **$17-19** | 빠른 로딩, 관리 간편 |

**프론트엔드 S3 버킷 상세 비용:**

- 스토리지: ~$1 (10GB 정적 파일 기준)
- 요청: ~$0.5 (월 10만 요청 기준)
- 전송량: CloudFront로 무료

### 비용 최적화 권장사항

1. **EC2 Spot 인스턴스**: 최대 90% 절약 가능 (단, 중단 위험)
2. **NAT 인스턴스**: NAT Gateway 대신 EC2 기반 (관리 복잡)
3. **CloudFront 가격 클래스**: 필요시 전 세계 → 미국/유럽만
4. **S3 Intelligent-Tiering**: 액세스 패턴에 따른 자동 비용 최적화

---

## 🔒 보안 고려사항

### 네트워크 보안

- 모든 애플리케이션 서비스는 **프라이빗 서브넷**에 배치
- **보안 그룹**으로 최소 권한 원칙 적용
- **NACLs** 미사용 (기본값으로 모든 트래픽 허용)

### 데이터 보안

- **S3 퍼블릭 액세스 완전 차단**
- **EBS 볼륨 암호화** 활성화
- **CloudFront OAC**로 S3 직접 접근 차단

### 접근 제어

- **IAM 최소 권한** 원칙 적용
- **임시 자격 증명** 사용 (IAM 역할)
- **SSH 키**로만 EC2 접근

### 모니터링

- **CloudWatch** 로그 수집 및 모니터링
- **ALB 액세스 로그** 기록
- **CloudFront 로그** S3 저장

---

## 🚀 배포 및 관리

### 초기 배포 순서 ⭐ **실제 경험 반영**

1. **기본 설정**

   - `terraform.tfvars` 설정 (us-east-1 리전)
   - `next.config.ts` → `output: 'export'` 모드 변경
   - SSH 키 페어 준비

2. **인프라 초기 배포** (임시 nginx 이미지)

   ```bash
   terraform init
   terraform plan
   terraform apply -auto-approve
   ```

3. **Docker 이미지 빌드 및 푸시** ⚠️ **중요: 플랫폼 지정 필수**

   ```bash
   # ECR 로그인
   aws ecr get-login-password --region us-east-1 | docker login --username AWS --password-stdin 084828586938.dkr.ecr.us-east-1.amazonaws.com

   # x86_64 플랫폼으로 빌드 (중요!)
   cd ecg-backend
   docker build --platform linux/amd64 -t 084828586938.dkr.ecr.us-east-1.amazonaws.com/ecg-project-pipeline-dev-api:latest .
   docker push 084828586938.dkr.ecr.us-east-1.amazonaws.com/ecg-project-pipeline-dev-api:latest
   ```

4. **실제 이미지로 업데이트**

   - `terraform.tfvars`에서 `api_container_image` 수정
   - `terraform apply -auto-approve` 재실행

5. **프론트엔드 배포** (옵션)
   ```bash
   cd ecg-frontend
   yarn build
   aws s3 sync ./out/ s3://$(terraform output -raw s3_frontend_bucket_name)/ --delete
   aws cloudfront create-invalidation --distribution-id $(terraform output -raw cloudfront_distribution_id) --paths "/*"
   ```

### 운영 관리

- **ECS 서비스 스케일링**: 백엔드 API 서버 수 조정
- **EC2 인스턴스 타입 변경**: GPU 성능 조정
- **프론트엔드 업데이트**:
  1. `yarn build` → S3 업로드 → CloudFront 무효화
- **비디오 파일 관리**: S3 수명주기 정책으로 비용 최적화
- **API 업데이트**: ECR 이미지 푸시 → ECS 서비스 재배포

### 주요 이슈 및 해결 방법 ⭐ **신규 추가**

1. **Docker 플랫폼 이슈**

   - **문제**: Apple Silicon Mac에서 빌드한 ARM64 이미지가 ECS Fargate x86_64에서 실행 불가
   - **오류 메시지**: `image Manifest does not contain descriptor matching platform 'linux/amd64'`
   - **해결 방법**:
     ```bash
     docker build --platform linux/amd64 -t $ECR_REPO:latest .
     ```

2. **ECR 저장소 이름 오류**

   - **문제**: Terraform 출력에서 `api` → `apiatest`로 변경됨
   - **해결 방법**: 하드코드된 이름 사용
     ```bash
     docker push 084828586938.dkr.ecr.us-east-1.amazonaws.com/ecg-project-pipeline-dev-api:latest
     ```

3. **보안 그룹 순환 종속성**

   - **문제**: 보안 그룹이 서로를 참조하는 순환 참조
   - **해결 방법**: 단일 `aws_security_group_rule` 리소스로 분리

4. **CloudFront 함수 파일 없음**
   - **문제**: 외부 JS 파일을 찾을 수 없음
   - **해결 방법**: 인라인 코드로 변경
     ```hcl
     code = <<-EOF
       function handler(event) {
         // URL rewrite logic
       }
     EOF
     ```

### S3 정적 호스팅 장점 ⭐ **신규 정보**

- **비용 절약**: ECS 프론트엔드 대비 월 ~$17 절약
- **빠른 로딩**: CloudFront CDN으로 전 세계 배포
- **자동 스케일링**: 트래픽 증가 시 AWS가 자동 처리
- **관리 간편**: 서버 관리 불필요
- **제약 사항**: SSR, API Routes, ISR 미지원 (정적 파일만)

✨ **배포 완료 상태** (2025-09-01 기준)

- **인프라 상태**: 전체 배포 완료 및 정상 작동 중
- **ALB 엔드포인트**: `http://ecg-project-pipeline-dev-alb-1703405864.us-east-1.elb.amazonaws.com`
- **CloudFront URL**: `https://d31nzc58rhgh3i.cloudfront.net`
- **API 헬스체크**: ✓ 정상 응답 `{"status":"healthy","service":"backend"}`
- **ECS 서비스**: 2/2 태스크 정상 실행 중
- **데이터 플로우**: S3 업로드 → ALB 전달 → ECS FastAPI → EC2 GPU 모델 서버

이 문서는 실제 배포된 AWS 인프라 기준으로 작성되었으며, 모든 서비스가 정상 작동 중입니다.
